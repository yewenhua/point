angular.module("app").controller("ErcodeCtrl",["$scope","CommonFunction","DataLoad","toaster","divpage","FileUploader","$document","$timeout","$state",function(a,t,e,i,d,n,r,o,s){function l(t){if(""==a.data.bgImage)return void layer.msg("海报背景不能为空");var e="";"qr"==t?e='<img src="/backend/img/qr.jpg" />':"head"==t?e='<img src="/backend/img/lufei.jpeg" />':"nickname"==t?e="<div class=text>昵称</div>":"desc"==t&&(e="<div class=text>描述</div>");var i=$("#poster .drag").length+1,d=$('<div class="drag" type="'+t+'" index="'+i+'" style="z-index:'+i+'">'+e+'<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');$("#poster").append(d),c(d)}function c(a){var t=(a.attr("index"),new Resize(a,{Max:!0,mxContainer:"#poster"}));t.Set($(".rRightDown",a),"right-down"),t.Set($(".rLeftDown",a),"left-down"),t.Set($(".rRightUp",a),"right-up"),t.Set($(".rLeftUp",a),"left-up"),t.Set($(".rRight",a),"right"),t.Set($(".rLeft",a),"left"),t.Set($(".rUp",a),"up"),t.Set($(".rDown",a),"down"),t.Scale=!0;var e=a.attr("type");"nickname"!=e&&"desc"!=e&&"head"!=e&&"qr"!=e||(t.Scale=!1),new Drag(a,{Limit:!0,mxContainer:"#poster"}),$(".drag .remove").unbind("click").click(function(){$(this).parent().remove()})}a.data={},a.data.bgImage="",a.data.bg_url="",a.data.json_data=[],a.data.isNew=!0,a.loading=!0,a.haveData=!1,a.posterData=function(){a.loading=!0;var t=e.posterData({type:1});return t.then(function(t){if(a.loading=!1,t&&0==t.code){a.data=t.data,a.haveData=!0,a.data.bgImage=a.data.bg_url,a.data.json_data=angular.fromJson(a.data.json_data);for(var e=0;e<a.data.json_data.length;e++){var i=e+1,d=a.data.json_data[e].type;if("head"==a.data.json_data[e].type)var n='<img src="/backend/img/lufei.jpeg" />',r=$('<div class="drag" style="left:'+a.data.json_data[e].left+"px; top:"+a.data.json_data[e].top+"px; height:"+a.data.json_data[e].height+"px; width:"+a.data.json_data[e].width+'px;" type="'+d+'" index="'+i+'" style="z-index:'+i+'">'+n+'<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');else if("qr"==a.data.json_data[e].type)var n='<img src="/backend/img/qr.jpg" />',r=$('<div class="drag" style="left:'+a.data.json_data[e].left+"px; top:"+a.data.json_data[e].top+"px; height:"+a.data.json_data[e].height+"px; width:"+a.data.json_data[e].width+'px;" type="'+d+'" index="'+i+'" style="z-index:'+i+'">'+n+'<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');else if("nickname"==a.data.json_data[e].type)var n='<div class="text" style="font-size:'+a.data.json_data[e].fontSize+"; color:"+a.data.json_data[e].color+';">昵称</div>',r=$('<div class="drag" color="'+a.data.json_data[e].color+'" size="'+a.data.json_data[e].fontSize+'" style="left:'+a.data.json_data[e].left+"px; top:"+a.data.json_data[e].top+"px; height:"+a.data.json_data[e].height+"px; width:"+a.data.json_data[e].width+'px;" type="'+d+'" index="'+i+'" style="z-index:'+i+'">'+n+'<div class="rRightDown"> </div><div class="rLeftDown"> </div><div class="rRightUp"> </div><div class="rLeftUp"> </div><div class="rRight"> </div><div class="rLeft"> </div><div class="rUp"> </div><div class="rDown"></div></div>');$("#poster").append(r),c(r)}a.data.isNew=!1}else a.haveData=!1,a.data.bgImage="",a.data.json_data=[],a.data.isNew=!0},function(){a.loading=!1,a.haveData=!1,i.pop("error","海报设置","获取数据出错！")})},a.posterData(),a.submitBtnHtml="提交",a.submitActive=!1,a.submitUpload=function(){0==a.submitActive&&(a.submitActive=!0,a.uploader.queue.length<=0&&!a.data.isNew?a.editPoster():a.uploader.queue.length>=1?p.uploadAll():i.pop("error","海报设置","海报背景不能为空"))},a.editPoster=function(){if(a.data.isNew){if(a.uploader.queue.length<=0)return a.submitActive=!1,i.pop("error","海报设置","背景图片不能为空"),!1;angular.forEach(a.uploader.queue,function(t){a.data.bg_url=t.file.url})}else a.uploader.queue.length<=0?a.data.bg_url="":angular.forEach(a.uploader.queue,function(t){a.data.bg_url=t.file.url});a.data.json_data=[];for(var t=document.querySelectorAll(".drag"),d=0;d<t.length;d++){var n=$(t[d]).attr("type"),r="",o={type:n,left:$(t[d]).position().left,top:$(t[d]).position().top};"head"==n||"qr"==n?(r=$(t[d]).children("img"),o.width=$(t[d]).width(),o.height=$(t[d]).height()):"desc"!=n&&"nickname"!=n||(r=$(t[d]).children(".text"),o.fontSize=r.css("font-size"),o.color=r.css("color"),o.height=r.height()),a.data.json_data.push(o)}var s=e.editPoster({id:a.data.isNew?"":a.data.id,json_data:a.data.json_data,bg_url:a.data.bg_url,type:1});return s.then(function(t){a.submitActive=!1,t&&0==t.code?i.pop("success","海报设置","保存成功"):i.pop("error","海报设置",t.message)},function(){a.submitActive=!1,i.pop("error","海报设置","保存海报出错")})};var p=a.uploader=new n({url:"/backend/upload_soft.php"});p.filters.push({name:"customFilter",fn:function(a,t){return this.queue.length<10}}),p.onAfterAddingFile=function(t){angular.forEach(a.uploader.queue,function(t){var e=t.file.name;return-1===e.indexOf(".jpg")&&-1===e.indexOf(".jpeg")&&-1===e.indexOf(".png")&&-1===e.indexOf(".gif")?(i.pop("error","海报设置","上传文件扩展名必须为：.jpg .png .jpeg .gif"),a.uploader.queue.pop(),!1):void(a.uploader.queue.length>1&&a.uploader.queue.splice(0,1))})},p.onCompleteItem=function(t,e,d,n){0==e.code?($(".bootstrap-filestyle").children("input").val(""),t.file.url="/backend/uploads/"+e.file,t.file.save_file_name=e.file,a.editPoster()):(a.submitActive=!1,i.pop("error","海报设置",e.answer))},angular.element(document.querySelector(".btn-nickname")).on("click",function(a){var t=$(this).data("type");l(t)}),angular.element(document.querySelector(".btn-head")).on("click",function(a){var t=$(this).data("type");l(t)}),angular.element(document.querySelector(".btn-desc")).on("click",function(a){$(this).data("type")}),angular.element(document.querySelector(".btn-qr")).on("click",function(a){var t=$(this).data("type");l(t)}),angular.element(document.querySelector("#fileInput")).on("change",function(t){var e=t.currentTarget.files[0],i=new FileReader;i.onload=function(t){a.$apply(function(a){a.data.bgImage=t.target.result})},i.readAsDataURL(e)})}]);
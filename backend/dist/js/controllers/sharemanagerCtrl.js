angular.module("app").controller("SharemanagerCtrl",["$scope","CommonFunction","DataLoad","toaster","divpage","$modal","$stateParams",function(t,a,e,n,l,i,o){t.haveData=!0,t.loading=!0,t.query="",t.page=1,t.totalPage=1,t.perPage=10,t.dataList=[],t.init=!0,t.selectAll=!1,t.all_delete_disabled=!0,t.all_delete_html="删除",t.submit=!1,t.init_loading=!0,t.radioModel=99,t.plusPoint=0,t.minusPoint=0,angular.isUndefined(o.userid)?t.userid="empty":t.userid=o.userid,t.$watch("radioModel",function(a,e){a!=e&&(t.init_loading||(t.page=1,t.getAllData()))}),t.dateSelectSingle={start:moment(new Date).utc().startOf("day"),end:""},t.$watch("dateSelectSingle.start",function(a,e){a!=e&&(t.init=!1,t.page=1,t.getAllData())},!0),t.monthAgo=function(){var t=new Date,a=t.getTime()-2592e6,e=new Date;e.setTime(a);var n=moment(e).utc().startOf("day").format("YYYY-MM-DD");return n},t.dateSelectRange={start:moment(t.monthAgo()).utc().startOf("day"),end:moment().utc().startOf("day")},t.$watch("dateSelectRange",function(a,e){a!=e&&(t.init=!1,t.page=1,t.getAllData())},!0),t.$watch("status",function(a,e){a!=e&&(t.page=1,t.getAllData())}),t.getAllData=function(){t.loading=!0;var a=e.getSharemanagerPageData({searchkey:t.query,status:t.radioModel,start:t.dateSelectRange.start.format("YYYY-MM-DD"),end:t.dateSelectRange.end.format("YYYY-MM-DD"),offset:(t.page-1)*t.perPage,num:t.perPage,userid:t.userid});return a.then(function(a){if(a&&0==a.code)if(t.plusPoint=a.data.plusPoint,t.minusPoint=a.data.minusPoint,0!=a.data.data.length){t.haveData=!0,t.dataList=a.data.data,t.totalPage=Math.ceil(a.data.count/t.perPage);var e=$("#divpage-page");l.getready(e,t.totalPage,t.page)}else t.dataList=[],n.pop("success","分享管理","没有数据！"),t.haveData=!1;else t.plusPoint=0,t.minusPoint=0,t.dataList=[],t.haveData=!1,n.pop("error","分享管理",a.message);t.loading=!1,t.init_loading=!1},function(){t.plusPoint=0,t.minusPoint=0,t.dataList=[],t.haveData=!1,t.loading=!1,t.init_loading=!1,n.pop("error","分享管理","获取数据出错！")})},t.getAllData(),t.isFirst=function(t){return 1==t},t.isDisable=function(a){return 1==a&&1==t.totalPage?!0:!(a<t.totalPage)},t.getInfoPage=function(a){a<=t.totalPage&&a>0&&(t.page=a,t.getAllData())},t.divpageByPage=function(a){var e=$(a.currentTarget).html(),n=Number(e);angular.isNumber(n)&&n>0&&t.getInfoPage(n)},t.searchData=function(){t.page=1,t.getAllData()},t.$watch("dataList",function(a,e){a!=e&&t.dataList.length>0&&(t.num=0,t.all=0,angular.forEach(t.dataList,function(a,e){a.selected&&t.num++,t.all++}),t.num>0?t.all_delete_disabled=!1:t.all_delete_disabled=!0,t.num==t.all?t.selectAll=!0:t.selectAll=!1)},!0),t.$watch("selectAll",function(a,e){a!=e&&t.dataList.length>0&&(a?angular.forEach(t.dataList,function(t,a){t.selected=!0}):(t.count=0,t.all=0,angular.forEach(t.dataList,function(a,e){a.selected&&t.count++,t.all++}),t.count==t.all&&angular.forEach(t.dataList,function(t,a){t.selected=!1})))}),t.deleteBatch=function(){if(1==confirm("确定要删除吗?")&&0==t.submit){t.submit=!0,t.idlist=[],angular.forEach(t.dataList,function(a,e){1==a.selected&&t.idlist.push(a.id)});var a=e.deleteSharemanagerBatch({idlist:JSON.stringify(t.idlist)});return a.then(function(a){t.all_disagree_disabled=!1,t.all_delete_html="删除",a&&0==a.code?(n.pop("success","分享管理",a.message),location.reload()):(t.submit=!1,n.pop("error","分享管理",a.message))},function(){t.submit=!1,t.all_disagree_disabled=!1,t.all_delete_html="删除",n.pop("error","分享管理","操作出错！")})}},t.detail=function(a,e){var n=i.open({templateUrl:"shareModalContent",controller:"shareModalInstanceCtrl",size:e,resolve:{item:function(){return a}}});n.result.then(function(a){angular.isDefined(a)&&angular.isDefined(a.type)&&"update"==a.type&&t.getAllData()},function(){})}}]),angular.module("app").controller("shareModalInstanceCtrl",["$rootScope","$scope","$modalInstance","toaster","item","$rootScope","DataLoad",function(t,a,e,n,l,t,i){a.item=angular.copy(l),a.submit=!1,a.cancle=function(){var t={type:"cancel"};e.close(t)},a.update=function(){var t={type:"update"};e.close(t)},a.deal_html="结算",a.deal=function(){layer.confirm("确定要结算吗？",{btn:["确定","取消"]},function(){if(layer.closeAll("dialog"),0==a.submit){a.submit=!0,a.deal_html="结算提交中…";var t=i.dealSharemanager({id:a.item.id});return t.then(function(t){a.deal_html="结算",t&&0==t.code?(n.pop("success","分享管理",t.message),a.update()):(a.submit=!1,n.pop("error","分享管理",t.message))},function(){a.submit=!1,a.deal_html="结算",n.pop("error","分享管理","操作出错！")})}},function(){})}}]);
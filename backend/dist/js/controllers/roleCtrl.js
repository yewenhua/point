"use strict";app.controller("RoleCtrl",["$rootScope","$scope","$http","$state","toaster","$timeout","DataLoad","$location","divpage",function(e,a,t,r,p,i,l,n,s){a.role={name:"",desc:"",privilege_list:[],isNew:!0},a.editing=!1,a.creating=!1,a.haveData=!0,a.loading=!0,a.query="",a.page=1,a.totalPage=1,a.perPage=10,a.dataList=[],a.privilegeData=[],a.cancel=function(){a.editing=!1,a.creating=!1},a.isFirst=function(e){return 1==e},a.isDisable=function(e){return 1==e&&1==a.totalPage?!0:!(e<a.totalPage)},a.getInfoPage=function(e){e<=a.totalPage&&e>0&&(a.page=e,a.getAllData())},a.divpageByPage=function(e){var t=$(e.currentTarget).html(),r=Number(t);angular.isNumber(r)&&r>0&&a.getInfoPage(r)},a.getAllPrivilegeData=function(){var e=l.getAllPrivilegeData({});return e.then(function(e){e&&0==e.code?0!=e.data.length?(a.privilegeData=e.data,angular.forEach(a.privilegeData,function(e){e.readSelected=!1,e.writeSelected=!1})):(a.privilegeData=[],p.pop("success"," 角色设置","没有数据！")):(a.privilegeData=[],p.pop("error"," 角色设置",e.message))},function(){a.privilegeData=[],p.pop("error"," 角色设置"," 获取权限列表出错！")})},a.getAllPrivilegeData(),a.searchData=function(){a.page=1,a.getAllData()},a.getAllData=function(){var e=l.getRolePageData({searchkey:a.query,offset:(a.page-1)*a.perPage,num:a.perPage});return e.then(function(e){if(e&&0==e.code)if(0!=e.data.data.length){a.haveData=!0,a.dataList=e.data.data,angular.forEach(a.dataList,function(e,t){for(var r=JSON.parse(e.privilege_list),p="",i=0;i<r.length;i++)""==p?p=r[i].page_name:p+=" "+r[i].page_name;a.dataList[t].privilegeName=p}),a.totalPage=Math.ceil(e.data.count/a.perPage);var t=$("#divpage-page");s.getready(t,a.totalPage,a.page)}else a.dataList=[],p.pop("success"," 角色设置","没有数据！"),a.haveData=!1;else a.dataList=[],a.haveData=!1,p.pop("error"," 角色设置",e.message);a.loading=!1},function(){a.dataList=[],a.haveData=!1,a.loading=!1,p.pop("error"," 角色设置"," 获取数据出错！")})},a.getAllData(),a.active=!1,a.submitHtml="提交",a.editRole=function(){if(""==a.role.name)return p.pop("error","角色设置","页面名称不能为空！"),!1;if(""==a.role.desc)return p.pop("error","角色设置","页面URL不能为空！"),!1;if(a.role.privilege_list=[],angular.forEach(a.privilegeData,function(e){if(e.readSelected||e.writeSelected){var t={};t.id=e.id,t.page_name=e.page_name,t.page_url=e.page_url,t.page_state=e.page_state,e.readSelected?e.readSelected=1:e.readSelected=0,e.writeSelected?e.writeSelected=1:e.writeSelected=0,t.readSelected=e.readSelected,t.writeSelected=e.writeSelected,a.role.privilege_list.push(t)}}),0==a.role.privilege_list.length)return p.pop("error","角色设置","角色权限不能为空！"),!1;if(0==a.active){a.active=!0,a.submitHtml="正在提交……";var e=l.editRole({id:a.role.isNew?"":a.role.id,name:a.role.name,desc:a.role.desc,privilege_list:JSON.stringify(a.role.privilege_list)});return e.then(function(e){e&&0==e.code?(p.pop("success","角色设置","修改成功！"),1==a.role.isNew&&(a.role.id=e.data,a.role.isNew=!1),a.role={name:"",desc:"",privilege_list:[],isNew:!1},a.editing=!1,a.creating=!1,a.haveData=!0,a.loading=!0,angular.forEach(a.privilegeData,function(e){e.readSelected=!1,e.writeSelected=!1}),a.getAllData()):p.pop("error","角色设置","角色设置出错！"),a.active=!1,a.submitHtml="提交"},function(){a.active=!1,a.submitHtml="提交",p.pop("error","角色设置","未知错误，请刷新重试！")})}},a.createRole=function(){a.role={name:"",desc:"",privilege_list:[],isNew:!0},a.creating=!0,angular.forEach(a.privilegeData,function(e){e.readSelected=!1,e.writeSelected=!1})},a.updateRole=function(e){a.editing=!0,a.role=angular.copy(e),a.role.isNew=!1,a.role.privilege_list=JSON.parse(a.role.privilege_list),angular.forEach(a.privilegeData,function(e,a){e.readSelected=!1,e.writeSelected=!1}),angular.forEach(a.role.privilege_list,function(e,t){angular.forEach(a.privilegeData,function(a,t){e.id==a.id&&(1==e.readSelected?a.readSelected=!0:a.readSelected=!1,1==e.writeSelected?a.writeSelected=!0:a.writeSelected=!1)})})},a.deleteRole=function(e){1==confirm("确定要删除吗?")&&a.deleteRoleNow(e)},a.deleteRoleNow=function(e){var t=l.deleteRole({id:e.id});return t.then(function(e){e&&0==e.code?(p.pop("success","角色设置",e.message),a.getAllData()):p.pop("error","角色设置",e.message)},function(){p.pop("error","角色设置"," 删除角色设置出错！")})},a.changeRead=function(e){e.readSelected||(e.writeSelected=!1)},a.changeWrite=function(e){e.writeSelected&&(e.readSelected=!0)},a.goods=function(e){return"app.goodslist"==e.page_state||"app.category"==e.page_state||"app.banner"==e.page_state||"app.article"==e.page_state||"app.merchantgoods"==e.page_state},a.orderlist=function(e){return"app.orderlist"==e.page_state||"app.rankorder"==e.page_state||"app.sharemanager"==e.page_state},a.member=function(e){return"app.userlist"==e.page_state||"app.upgrade"==e.page_state||"app.userimport"==e.page_state||"app.quick"==e.page_state||"app.center"==e.page_state||"app.business"==e.page_state||"app.repeatcompensation"==e.page_state},a.financial_detail=function(e){return"app.declaration"==e.page_state||"app.cashlist"==e.page_state||"app.commisionlist"==e.page_state||"app.exchangelist"==e.page_state||"app.consumelist"==e.page_state||"app.useablelist"==e.page_state||"app.sharelist"==e.page_state||"app.wallet"==e.page_state},a.financial_manager=function(e){return"app.waitlist"==e.page_state||"app.takecash"==e.page_state||"app.repeatmanager"==e.page_state},a.statistic=function(e){return"app.shareholder"==e.page_state||"app.merchant"==e.page_state||"app.salerank"==e.page_state||"app.salegoods"==e.page_state||"app.consumerank"==e.page_state||"app.declarationrank"==e.page_state||"app.memberrank"==e.page_state},a.operate=function(e){return"app.declarationsetting"==e.page_state||"app.commisionsetting"==e.page_state||"app.servicesetting"==e.page_state||"app.logistic"==e.page_state||"app.ercode"==e.page_state},a.plugin=function(e){return"app.message"==e.page_state||"app.smstemplate"==e.page_state},a.system=function(e){return"app.system"==e.page_state||"app.adminsetting"==e.page_state||"app.department"==e.page_state||"app.privilege"==e.page_state||"app.role"==e.page_state||"app.wechatsetting"==e.page_state||"app.smssetting"==e.page_state||"app.log"==e.page_state},a.my=function(e){return"app.personal"==e.page_state||"app.chgpwd"==e.page_state||"app.welcome"==e.page_state}}]);
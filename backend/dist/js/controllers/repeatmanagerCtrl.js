angular.module("app").controller("RepeatmanagerCtrl",["$scope","CommonFunction","DataLoad","toaster","divpage","$modal","$stateParams",function(e,a,t,l,n,i,d){e.haveData=!0,e.loading=!0,e.query="",e.page=1,e.totalPage=1,e.perPage=10,e.dataList=[],e.init=!0,e.selectAll=!1,e.all_delete_disabled=!0,e.all_delete_html="删除",e.submit=!1,e.is_delete=!1,e.radioModel=99,e.init_loading=!0,angular.isUndefined(d.userid)?e.userid="empty":e.userid=d.userid,e.$watch("radioModel",function(a,t){a!=t&&(e.init_loading||(e.page=1,e.getAllData()))}),e.$watch("is_delete",function(a,t){a!=t&&(e.page=1,e.getAllData())}),e.dateSelectSingle={start:moment(new Date).utc().startOf("day"),end:""},e.$watch("dateSelectSingle.start",function(a,t){a!=t&&(e.init=!1,e.page=1,e.getAllData())},!0),e.monthAgo=function(){var e=new Date,a=e.getTime()-2592e6,t=new Date;t.setTime(a);var l=moment(t).utc().startOf("day").format("YYYY-MM-DD");return l},e.dateSelectRange={start:moment(e.monthAgo()).utc().startOf("day"),end:moment().utc().startOf("day")},e.$watch("dateSelectRange",function(a,t){a!=t&&(e.init=!1,e.page=1,e.getAllData())},!0),e.getAllData=function(){e.loading=!0;var a=t.getRepeatPageData({searchkey:e.query,is_delete:e.is_delete?1:0,type:e.radioModel,start:e.dateSelectRange.start.format("YYYY-MM-DD"),end:e.dateSelectRange.end.format("YYYY-MM-DD"),offset:(e.page-1)*e.perPage,num:e.perPage,userid:e.userid});return a.then(function(a){if(a&&0==a.code)if(0!=a.data.data.length){e.haveData=!0,e.dataList=a.data.data,e.totalPage=Math.ceil(a.data.count/e.perPage);var t=$("#divpage-page");n.getready(t,e.totalPage,e.page)}else e.dataList=[],l.pop("success","复投管理","没有数据！"),e.haveData=!1;else e.dataList=[],e.haveData=!1,l.pop("error","复投管理",a.message);e.loading=!1,e.init_loading=!1},function(){e.dataList=[],e.haveData=!1,e.loading=!1,e.init_loading=!1,l.pop("error","复投管理","获取数据出错！")})},e.getAllData(),e.isFirst=function(e){return 1==e},e.isDisable=function(a){return 1==a&&1==e.totalPage?!0:!(a<e.totalPage)},e.getInfoPage=function(a){a<=e.totalPage&&a>0&&(e.page=a,e.getAllData())},e.divpageByPage=function(a){var t=$(a.currentTarget).html(),l=Number(t);angular.isNumber(l)&&l>0&&e.getInfoPage(l)},e.searchData=function(){e.page=1,e.getAllData()},e.$watch("dataList",function(a,t){a!=t&&e.dataList.length>0&&(e.num=0,e.all=0,angular.forEach(e.dataList,function(a,t){a.selected&&e.num++,e.all++}),e.num>0?e.all_delete_disabled=!1:e.all_delete_disabled=!0,e.num==e.all?e.selectAll=!0:e.selectAll=!1)},!0),e.$watch("selectAll",function(a,t){a!=t&&e.dataList.length>0&&(a?angular.forEach(e.dataList,function(e,a){e.selected=!0}):(e.count=0,e.all=0,angular.forEach(e.dataList,function(a,t){a.selected&&e.count++,e.all++}),e.count==e.all&&angular.forEach(e.dataList,function(e,a){e.selected=!1})))}),e.deleteBatch=function(){if(1==confirm("确定要删除吗?")&&0==e.submit){e.submit=!0,e.idlist=[],angular.forEach(e.dataList,function(a,t){1==a.selected&&e.idlist.push(a.id)});var a=t.deleteRepeatBatch({idlist:JSON.stringify(e.idlist)});return a.then(function(a){e.all_disagree_disabled=!1,e.all_delete_html="删除",a&&0==a.code?(l.pop("success","复投管理",a.message),location.reload()):(e.submit=!1,l.pop("error","复投管理",a.message))},function(){e.submit=!1,e.all_disagree_disabled=!1,e.all_delete_html="删除",l.pop("error","复投管理","操作出错！")})}}}]);
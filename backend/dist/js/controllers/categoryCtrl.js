app.controller("CategoryCtrl",["$scope","$timeout","toaster","DataLoad","CommonFunction","FileUploader",function(e,t,r,a,n,i){e.rightColShow=!1,e.editing=!1,e.branch={},e.branch.label="",e.branch.path="",e.branch.isNew=!1,e.editItem={},e.routerBranchNum=0,e.loading=!0,e.data={},e.data.bgImage="",e.data.bg_url="";var o;e.my_tree_handler=function(t){e.rightColShow=!0,e.editing=!0,e.tab(1),e.editItem.label=angular.copy(t.label),e.editItem.node_id=angular.copy(t.node_id),e.editItem.path=angular.copy(t.path),e.editItem.selected=angular.copy(t.selected),e.editItem.orderby=angular.copy(t.orderby),e.editItem.open=1==t.is_open,e.editItem.img_url=angular.copy(t.img_url),e.editItem.url=angular.copy(t.url),e.data.bgImage=angular.copy(t.img_url),t.img_url||(document.querySelector("#preview").src=""),e.editItem.isNew=!1,e.branch=t;var r;return e.output="当前分支: "+t.label,(null!=(r=t.data)?r.description:void 0)?e.output+="("+t.data.description+")":void 0},e.my_data=[],e.my_tree=o={},e.editItem={label:"新栏目",path:"",is_root:0,isNew:!0,top_nav:!1,bottom_nav:!1,content_nav:!1,open:!1,orderby:""},e.try_adding_a_branch=function(){var t=o.get_selected_branch(),r=angular.copy(e.editItem);return o.add_branch(t,r)},e.adding_a_root_branch=function(){var t=angular.copy(e.editItem);return o.add_root_branch(t)},e.delete_branch=function(){var e,t;return e=o.get_selected_branch(),t=o.get_parent_branch(e),angular.isUndefined(e)?(r.pop("error","栏目管理","请先选择分支！"),!1):void(angular.isUndefined(t)?o.delete_root_branch(e):o.delete_branch(t,e))},e.expand_all=function(){o.expand_all()},e.insertTree=function(){e.tab(0),e.editing=!0;var t=o.get_selected_branch();if(angular.isUndefined(t)||null==t)return r.pop("error","栏目管理","请先选择分支！"),!1;var a=String(angular.copy(t.path));if(a.split("/").length>=4)return r.pop("error","栏目管理","不能再新建子分支了！"),!1;var n=o.get_selected_branch();e.editItem.label="新栏目",e.editItem.node_id="",e.editItem.isNew=!0,e.editItem.isRoot=!1,e.editItem.top_nav=!1,e.editItem.bottom_nav=!1,e.editItem.content_nav=!1,e.editItem.img_url="",e.editItem.url="",e.editItem.open=!1,e.data.bgImage="",document.querySelector("#preview").src="",e.editItem.orderby=Number(n.children.length)+1,e.editItem.parent_path=n.path},e.insertRootTree=function(){e.tab(2),e.editing=!0,e.editItem.label="新根栏目",e.editItem.node_id="",e.editItem.isNew=!0,e.editItem.isRoot=!0,e.editItem.top_nav=!1,e.editItem.bottom_nav=!1,e.editItem.content_nav=!1,e.editItem.open=!1,e.editItem.orderby=e.routerBranchNum+1,e.editItem.parent_path="",e.editItem.img_url="",e.editItem.url="",e.data.bgImage="",document.querySelector("#preview").src=""},e.updatetTree=function(){e.tab(1),e.editing=!0;var t=o.get_selected_branch();e.editItem.label=angular.copy(t.label),e.editItem.node_id=angular.copy(t.node_id),e.editItem.isNew=!1,e.editItem.orderby=angular.copy(t.orderby),t.is_root?e.editItem.isRoot=!0:e.editItem.isRoot=!1,e.editItem.parent_path=angular.copy(t.path),e.editItem.open=1==t.is_open,e.editItem.img_url=angular.copy(t.orderby),e.editItem.url=angular.copy(t.url),e.data.bgImage=angular.copy(t.img_url),t.img_url||(document.querySelector("#preview").src="")},e.deleteNote=function(){if(1==confirm("确定要删除吗?")){var t=o.get_selected_branch();if(angular.isUndefined(t))return r.pop("error","栏目管理","请先选择分支！"),!1;e.deleteTree(t)}},e.submitBranch=function(){e.uploader.queue.length<=0&&!e.editItem.isNew?e.editTree():e.uploader.queue.length>=1?d.uploadAll():e.editTree()},e.tabs=[!0,!1,!1,!1],e.tab=function(t){angular.forEach(e.tabs,function(t,r){e.tabs[r]=!1}),e.tabs[t]=!0},e.originalData=[],e.getAllData=function(){e.my_data=[],e.loading=!0;var n=a.treeAllData({});return n.then(function(a){if(a&&0==a.code)if(0!=a.data.length){e.originalData=a.data;var n=[];angular.forEach(e.originalData,function(e,t){e.children=[],1==e.is_root&&n.push(e)});for(var i=0;i<n.length;i++)angular.forEach(e.originalData,function(e,t){if(1!=e.is_root){var r=e.path.split("/");2==r.length&&r[0]==n[i].path&&n[i].children.push(e)}});for(var i=0;i<n.length;i++)angular.forEach(e.originalData,function(e,t){var r=e.path.split("/");if(1!=e.is_root&&3==r.length&&n[i].children.length>0)for(var a=0;a<n[i].children.length;a++){var o=n[i].children[a].path.split("/"),d=r[0]+r[1],l=o[0]+o[1];d==l&&n[i].children[a].children.push(e)}});for(var i=0;i<n.length;i++)angular.forEach(e.originalData,function(e,t){var r=e.path.split("/");if(1!=e.is_root&&4==r.length&&n[i].children.length>0)for(var a=0;a<n[i].children.length;a++)if(n[i].children[a].children.length>0)for(var o=0;o<n[i].children[a].children.length;o++){var d=n[i].children[a].children[o].path.split("/"),l=r[0]+r[1]+r[2],u=d[0]+d[1]+d[2];l==u&&n[i].children[a].children[o].children.push(e)}});e.my_data=n,e.routerBranchNum=n.length}else r.pop("error","栏目管理","没有数据！");else r.pop("error","栏目管理",a.message);e.loading=!1,t(function(){e.expand_all()},200)},function(){e.loading=!1,r.pop("error","栏目管理"," 获取栏目管理出错！")})},e.getAllData(),e.active=!1,e.editTree=function(){if(""==e.editItem.label)return r.pop("error","栏目管理","分支不能为空！"),!1;if(""==e.editItem.orderby)return r.pop("error","栏目管理","导航顺序不能为空！"),!1;if(e.editItem.isNew?e.uploader.queue.length<=0?e.data.bg_url="":angular.forEach(e.uploader.queue,function(t){e.data.bg_url=t.file.url}):e.uploader.queue.length<=0?e.data.bg_url="":angular.forEach(e.uploader.queue,function(t){e.data.bg_url=t.file.url}),!e.active){e.active=!0;var t=a.editTree({node_id:e.editItem.isNew?"":e.editItem.node_id,label:e.editItem.label,path:e.editItem.isNew?e.editItem.parent_path:e.editItem.path,is_root:e.editItem.isRoot?1:0,orderby:e.editItem.orderby,img_url:e.data.bg_url?e.data.bg_url:e.editItem.img_url,is_open:e.editItem.open?1:0});return t.then(function(t){e.active=!1,t&&0==t.code?0!=t.data.length?(r.pop("success","栏目管理","保存成功！"),1==e.editItem.isNew?(e.editItem.node_id=angular.copy(t.data.node_id),e.editItem.path=angular.copy(t.data.path),e.editItem.isNew=!1,0==e.editItem.isRoot?(e.editItem.is_root=0,e.try_adding_a_branch(),e.branch.is_root=0):(e.editItem.is_root=1,e.adding_a_root_branch(),e.branch.is_root=1,e.routerBranchNum=e.routerBranchNum+1),e.tab(1),e.editItem.url=angular.copy(t.data.url)):(e.branch.orderby=angular.copy(e.editItem.orderby),e.branch.label=angular.copy(e.editItem.label),e.branch.is_root=e.editItem.isRoot?1:0)):r.pop("error","栏目管理","没有数据！"):r.pop("error","栏目管理",t.message)},function(){e.active=!1,r.pop("error","栏目管理"," 保存栏目管理出错！")})}},e.deleteTree=function(t){var n=a.deleteTree({node_id:t.path});return n.then(function(t){t&&0==t.code?(r.pop("success","栏目管理","删除成功！"),e.delete_branch()):r.pop("error","栏目管理",t.message)},function(){r.pop("error","栏目管理"," 栏目管理出错！")})};var d=e.uploader=new i({url:"/backend/upload_soft.php"});d.filters.push({name:"customFilter",fn:function(e,t){return this.queue.length<10}}),d.onAfterAddingFile=function(t){angular.forEach(e.uploader.queue,function(t){var a=t.file.name;return-1===a.indexOf(".jpg")&&-1===a.indexOf(".jpeg")&&-1===a.indexOf(".png")&&-1===a.indexOf(".gif")?(r.pop("error","封面设置","上传文件扩展名必须为：.jpg .png .jpeg .gif"),e.uploader.queue.pop(),!1):void(e.uploader.queue.length>1&&e.uploader.queue.splice(0,1))})},d.onCompleteItem=function(t,a,n,i){0==a.code?($(".bootstrap-filestyle").children("input").val(""),t.file.url="/backend/uploads/"+a.file,t.file.save_file_name=a.file,e.editTree()):(e.submitActive=!1,r.pop("error","封面设置",a.answer))},angular.element(document.querySelector("#fileInput")).on("change",function(t){var r=t.currentTarget.files[0],a=new FileReader;a.onload=function(t){e.$apply(function(e){e.data.bgImage=t.target.result})},a.readAsDataURL(r)})}]);
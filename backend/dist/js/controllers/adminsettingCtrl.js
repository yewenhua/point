"use strict";app.controller("AdminSettingCtrl",["$rootScope","$scope","$http","$state","toaster","$timeout","DataLoad","$location","divpage","CommonFunction",function(e,a,t,i,n,d,r,o,l,p){a.roleData=[],a.admin={},a.admin.name="",a.admin.dep_id="",a.admin.mobile="",a.admin.password="",a.admin.role_id="",a.admin.is_lock=!1,a.admin.isNew=!0,a.editing=!1,a.creating=!1,a.haveData=!0,a.loading=!0,a.query="",a.page=1,a.totalPage=1,a.perPage=10,a.dataList=[],a.departmentList=[],a.departmentLoading=!0,a.nextId="",a.getAllRoleData=function(){var e=r.getAllRoleData({});return e.then(function(e){e&&0==e.code?0!=e.data.length?a.roleData=e.data:(a.roleData=[],n.pop("success","管理员设置","没有数据！")):(a.roleData=[],n.pop("error","管理员设置",e.message))},function(){a.roleData=[],n.pop("error","管理员设置"," 获取角色列表出错！")})},a.getAllRoleData(),a.searchData=function(){a.page=1,a.getAllData()},a.getAllData=function(){var e=r.getAdminPageData({searchkey:a.query,offset:(a.page-1)*a.perPage,num:a.perPage});return e.then(function(e){if(e&&0==e.code)if(0!=e.data.data.length){a.haveData=!0,a.dataList=e.data.data,a.nextId=Number(e.last.id)+1,a.totalPage=Math.ceil(e.data.count/a.perPage);var t=$("#divpage-page");l.getready(t,a.totalPage,a.page)}else a.dataList=[],n.pop("success"," 管理员设置","没有数据！"),a.haveData=!1;else a.dataList=[],a.haveData=!1,n.pop("error"," 管理员设置",e.message);a.loading=!1},function(){a.dataList=[],a.haveData=!1,a.loading=!1,n.pop("error"," 管理员设置"," 获取数据出错！")})},a.getAllData(),a.departmentAllData=function(){a.departmentLoading=!0;var e=r.departmentAllData({});return e.then(function(e){e&&0==e.code?0!=e.data.length?(a.departmentLoading=!1,a.departmentList=e.data,angular.forEach(a.departmentList,function(e,a){e.selected=!1})):(a.departmentList=[],n.pop("success"," 管理员设置","没有数据！")):(a.departmentList=[],n.pop("error"," 管理员设置",e.message))},function(){a.departmentList=[],n.pop("error"," 管理员设置"," 获取数据出错！")})},a.departmentAllData(),a.active=!1,a.editAdmin=function(){if(""==a.admin.role_id)return n.pop("error","管理员设置","角色不能为空！"),!1;var e="";if(angular.forEach(a.departmentList,function(a,t){a.selected&&(""==e?e=a.id:e+=","+a.id)}),""==e)return n.pop("error","管理员设置","管辖部门不能为空！"),!1;if(a.admin.dep_id=e,0==a.active){a.active=!0;var t=r.editAdmin({id:a.admin.isNew?"":a.admin.id,name:a.admin.name,mobile:a.admin.mobile,password:a.admin.password,role_id:a.admin.role_id,dep_id:a.admin.dep_id,is_lock:a.admin.is_lock?1:0});return t.then(function(e){e&&0==e.code?(n.pop("success","管理员设置","保存成功！"),1==a.admin.isNew&&(a.admin.id=e.data,a.admin.isNew=!1),a.admin={name:"",mobile:"",password:"",role_id:"",dep_id:"",is_lock:!1,isNew:!1},a.editing=!1,a.creating=!1,a.haveData=!0,a.loading=!0,a.getAllData()):n.pop("error","管理员设置","管理员生成出错！"),a.active=!1},function(){a.active=!1,n.pop("error","管理员设置","未知错误，请刷新重试！")})}},a.createAdmin=function(){a.admin={name:"",mobile:"",password:"",role_id:"",dep_id:"",is_lock:!1,isNew:!0},a.creating=!0,angular.forEach(a.departmentList,function(e,a){e.selected=!1})},a.cancel=function(){a.editing=!1,a.creating=!1},a.updateAdmin=function(e){a.editing=!0,a.admin=angular.copy(e),a.admin.isNew=!1,a.admin.password="",a.admin.is_lock=1==a.admin.is_lock;var t=[];a.admin.dep_id&&-1!==a.admin.dep_id.indexOf(",")?t=a.admin.dep_id.split(","):a.admin.dep_id&&-1===a.admin.dep_id.indexOf(",")&&(t=[a.admin.dep_id]),angular.forEach(a.departmentList,function(e,a){t.length>0&&p.isInArray(t,e.id)?e.selected=!0:e.selected=!1})},a.deleteAdmin=function(e){1==confirm("确定要删除吗?")&&a.deleteAdminNow(e)},a.deleteAdminNow=function(e){var t=r.deleteAdmin({id:e.id});return t.then(function(e){e&&0==e.code?(n.pop("success","管理员设置",e.message),a.getAllData()):n.pop("error","管理员设置",e.message)},function(){n.pop("error","管理员设置"," 删除管理员设置出错！")})},a.isFirst=function(e){return 1==e},a.isDisable=function(e){return 1==e&&1==a.totalPage?!0:!(e<a.totalPage)},a.getInfoPage=function(e){e<=a.totalPage&&e>0&&(a.page=e,a.getAllData())},a.divpageByPage=function(e){var t=$(e.currentTarget).html(),i=Number(t);angular.isNumber(i)&&i>0&&a.getInfoPage(i)}}]);
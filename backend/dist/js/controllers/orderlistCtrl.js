angular.module("app").controller("OrderlistCtrl",["$scope","CommonFunction","DataLoad","toaster","divpage","$modal","$stateParams",function(e,t,a,r,o,i,n){e.haveData=!0,e.loading=!0,e.query="",e.page=1,e.totalPage=1,e.perPage=10,e.dataList=[],e.init=!0,e.init_loading=!0,e.selectAll=!1,e.all_delete_disabled=!0,e.all_delete_html="删除",e.submit=!1,e.radioModel=99,angular.isUndefined(n.status)?e.radioModel=99:e.radioModel=Number(n.status),e.$watch("radioModel",function(t,a){t!=a&&(e.init_loading||(e.page=1,e.getAllData()))}),e.dateSelectSingle={start:moment(new Date).utc().startOf("day"),end:""},e.$watch("dateSelectSingle.start",function(t,a){t!=a&&(e.init=!1,e.page=1,e.getAllData())},!0),e.monthAgo=function(){var e=new Date,t=e.getTime()-2592e6,a=new Date;a.setTime(t);var r=moment(a).utc().startOf("day").format("YYYY-MM-DD");return r},angular.isUndefined(n.start)||angular.isUndefined(n.end)?e.dateSelectRange={start:moment(e.monthAgo()).utc().startOf("day"),end:moment().utc().startOf("day")}:e.dateSelectRange={start:moment(new Date(n.start)).utc().startOf("day"),end:moment(new Date(n.end)).utc().startOf("day")},angular.isUndefined(n.comid)?(e.comid="empty",e.type="empty"):(e.comid=n.comid,e.type=n.type),e.$watch("dateSelectRange",function(t,a){t!=a&&(e.init=!1,e.page=1,e.getAllData())},!0),e.getAllData=function(){e.loading=!0;var t=a.getOrderPageData({searchkey:e.query,status:e.radioModel,start:e.dateSelectRange.start.format("YYYY-MM-DD"),end:e.dateSelectRange.end.format("YYYY-MM-DD"),offset:(e.page-1)*e.perPage,num:e.perPage,comid:e.comid,type:e.type});return t.then(function(t){if(t&&0==t.code)if(0!=t.data.data.length){e.haveData=!0,e.dataList=t.data.data,angular.forEach(e.dataList,function(e,t){e.face_url="/backend/uploads/"+e.goods_face}),e.totalPage=Math.ceil(t.data.count/e.perPage);var a=$("#divpage-page");o.getready(a,e.totalPage,e.page)}else e.dataList=[],r.pop("success","订单列表","没有数据！"),e.haveData=!1;else e.dataList=[],e.haveData=!1,r.pop("error","订单列表",t.message);e.loading=!1,e.init_loading=!1},function(){e.dataList=[],e.haveData=!1,e.loading=!1,r.pop("error","订单列表","获取数据出错！"),e.init_loading=!1})},e.getAllData(),e.isFirst=function(e){return 1==e},e.isDisable=function(t){return 1==t&&1==e.totalPage?!0:!(t<e.totalPage)},e.getInfoPage=function(t){t<=e.totalPage&&t>0&&(e.page=t,e.getAllData())},e.divpageByPage=function(t){var a=$(t.currentTarget).html(),r=Number(a);angular.isNumber(r)&&r>0&&e.getInfoPage(r)},e.searchData=function(){e.page=1,e.getAllData()},e.$watch("dataList",function(t,a){t!=a&&e.dataList.length>0&&(e.num=0,e.all=0,angular.forEach(e.dataList,function(t,a){t.selected&&e.num++,e.all++}),e.num>0?e.all_delete_disabled=!1:e.all_delete_disabled=!0,e.num==e.all?e.selectAll=!0:e.selectAll=!1)},!0),e.$watch("selectAll",function(t,a){t!=a&&e.dataList.length>0&&(t?angular.forEach(e.dataList,function(e,t){e.selected=!0}):(e.count=0,e.all=0,angular.forEach(e.dataList,function(t,a){t.selected&&e.count++,e.all++}),e.count==e.all&&angular.forEach(e.dataList,function(e,t){e.selected=!1})))}),e.deleteBatch=function(){if(1==confirm("确定要删除吗?")&&0==e.submit){e.submit=!0,e.idlist=[],angular.forEach(e.dataList,function(t,a){1==t.selected&&e.idlist.push(t.id)});var t=a.deleteOrderBatch({idlist:JSON.stringify(e.idlist)});return t.then(function(t){e.all_disagree_disabled=!1,e.all_delete_html="删除",t&&0==t.code?(r.pop("success","订单列表",t.message),location.reload()):(e.submit=!1,r.pop("error","订单列表",t.message))},function(){e.submit=!1,e.all_disagree_disabled=!1,e.all_delete_html="删除",r.pop("error","订单列表","操作出错！")})}},e.statusClass=function(e){return 0==e?"text-danger":1==e?"text-warning":2==e?"text-info":3==e?"text-success":4==e?"text-primary":5==e?"text-seven":6==e?"text-ten":7==e?"text-eleven":"text-default"},e.todo=function(t,a){var r=i.open({templateUrl:"todoModalContent",controller:"todoModalInstanceCtrl",size:a,resolve:{item:function(){return t}}});r.result.then(function(t){angular.isDefined(t)&&angular.isDefined(t.type)&&"update"==t.type&&e.getAllData()},function(){})}}]),angular.module("app").controller("todoModalInstanceCtrl",["$rootScope","$scope","$modalInstance","toaster","item","$rootScope","DataLoad",function(e,t,a,r,o,e,i){t.item=angular.copy(o),t.item.order_address=angular.copy(JSON.parse(o.order_address)),1==t.item.status&&(t.item.order_address.logisticName="",t.item.order_address.logisticNo="",t.item.order_address.memo=""),t.submit=!1,t.submitBtnHtml="提交",t.cancle=function(){var e={type:"cancel"};a.close(e)},t.update=function(){var e={type:"update"};a.close(e)},t.close_html="关闭订单",t.close=function(){layer.confirm("待发货或者已发货的订单关闭，将会退回用户所用掉的积分和现金！",{btn:["确定","取消"],title:"确定要关闭吗？",icon:3},function(){if(layer.closeAll("dialog"),0==t.submit){t.submit=!0;var e=4;t.close_html="关闭订单中…";var a=i.changeOrderStatus({id:t.item.id,status:e});return a.then(function(e){t.close_html="关闭订单",e&&0==e.code?(r.pop("success","订单",e.message),t.update()):(t.submit=!1,r.pop("error","订单",e.message))},function(){t.submit=!1,t.close_html="关闭订单",r.pop("error","订单","操作出错！")})}},function(){})},t.sure_html="确认订单",t.sure=function(){layer.confirm("确定要确认订单吗？",{btn:["确定","取消"]},function(){if(layer.closeAll("dialog"),0==t.submit){t.submit=!0;var e=3;t.sure_html="确认订单中…";var a=i.changeOrderStatus({id:t.item.id,status:e});return a.then(function(e){t.sure_html="确认订单",e&&0==e.code?(r.pop("success","订单",e.message),t.update()):(t.submit=!1,r.pop("error","订单",e.message))},function(){t.submit=!1,t.sure_html="确认订单",r.pop("error","订单","操作出错！")})}},function(){})},t.send_html="发货",t.send=function(){return t.item.order_address.logisticName?t.item.order_address.logisticNo?t.item.order_address.userName?t.item.order_address.telNumber?t.item.order_address.detailInfo?void layer.confirm("确定要发货吗？",{btn:["确定","取消"]},function(){if(layer.closeAll("dialog"),0==t.submit){t.submit=!0;t.send_html="提交发货中…";var a=i.submitLogisticsInfo({id:t.item.id,order_id:t.item.order_id,order_address:angular.toJson(t.item.order_address)});return a.then(function(a){t.send_html="发货",a&&0==a.code?(e.diffNum_no_review--,r.pop("success","订单",a.message),t.update()):(t.submit=!1,r.pop("error","订单",a.message))},function(){t.submit=!1,t.send_html="发货",r.pop("error","订单","操作出错！")})}},function(){}):(r.pop("error","订单","地址不能为空"),!1):(r.pop("error","订单","手机号不能为空"),!1):(r.pop("error","订单","收货人不能为空"),!1):(r.pop("error","订单","物流单号不能为空"),!1):(r.pop("error","订单","物流公司不能为空"),!1)},t.modify_html="修改",t.modify=function(){if(2==t.item.status){if(!t.item.order_address.logisticName)return r.pop("error","订单","物流公司不能为空"),!1;if(!t.item.order_address.logisticNo)return r.pop("error","订单","物流单号不能为空"),!1}else if(1==t.item.status){if(!t.item.order_address.userName)return r.pop("error","订单","收货人不能为空"),!1;if(!t.item.order_address.telNumber)return r.pop("error","订单","电话号码不能为空"),!1;if(!t.item.order_address.detailInfo)return r.pop("error","订单","地址不能为空"),!1}layer.confirm("确定要修改发货信息吗？",{btn:["确定","取消"]},function(){if(layer.closeAll("dialog"),0==t.submit){t.submit=!0,t.modify_html="提交修改中…";var e=i.modifyLogisticsInfo({id:t.item.id,order_id:t.item.order_id,order_address:angular.toJson(t.item.order_address)});return e.then(function(e){t.modify_html="修改",e&&0==e.code?(r.pop("success","订单",e.message),t.update()):(t.submit=!1,r.pop("error","订单",e.message))},function(){t.submit=!1,t.modify_html="修改",r.pop("error","订单","操作出错！")})}},function(){})},t.refund_html="退款",t.refund=function(){layer.confirm("确定要退款吗？",{btn:["确定","取消"]},function(){if(layer.closeAll("dialog"),0==t.submit){t.submit=!0,t.refund_html="退款提交中…";var e=i.submitRefundOrder({id:t.item.id,order_id:t.item.order_id});return e.then(function(e){t.refund_html="退款",e&&0==e.code?(r.pop("success","订单",e.message),t.update()):(t.submit=!1,r.pop("error","订单",e.message))},function(){t.submit=!1,t.refund_html="退款",r.pop("error","订单","操作出错！")})}},function(){})},t.agree_html="同意退款",t.disagree_html="拒绝退款",t.check=function(a){if("agree"==a)var o="确定要同意退款吗？";else var o="确定要拒绝退款吗？";layer.confirm(o,{btn:["确定","取消"]},function(){if(layer.closeAll("dialog"),0==t.submit){t.submit=!0,"agree"==a?t.agree_html="提交中…":t.disagree_html="提交中…";var o=i.checkRefundOrder({id:t.item.id,order_id:t.item.order_id,type:a});return o.then(function(a){t.agree_html="同意退款",t.disagree_html="拒绝退款",a&&0==a.code?(e.diffNum_no_refund--,r.pop("success","订单",a.message),t.update()):(t.submit=!1,r.pop("error","订单",a.message))},function(){t.submit=!1,t.agree_html="同意退款",t.disagree_html="拒绝退款",r.pop("error","订单","操作出错！")})}},function(){})}}]);
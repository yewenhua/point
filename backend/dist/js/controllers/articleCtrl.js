app.controller("ArticleCtrl",["$scope","$state","$timeout","toaster","DataLoad","divpage","FileUploader",function(e,t,a,r,l,i,n){e.dataList=[],e.branch=null,e.article={},e.article.title="",e.article.content="<p>请输入内容！</p>",e.article.abstracts="",e.article.img_url="",e.article.isNew=!1,e.haveData=!0,e.editing=!1,e.loading=!0,e.query="",e.page=1,e.totalPage=1,e.perPage=10,e.init=!0,e.all_delete_disabled=!0,e.selectAll=!1,e.all_delete_html="删除",e.moveable=!1,e.submit_html="提交",e.submiting=!1,e.data={},e.data.bgImage="",e.data.bg_url="",e.monthAgo=function(){var e=new Date,t=e.getTime()-2592e6,a=new Date;a.setTime(t);var r=moment(a).utc().startOf("day").format("YYYY-MM-DD");return r},e.createArticle=function(){e.editing=!0,e.article={},e.article.title="",e.article.content="<p>请输入内容！</p>",e.article.abstracts="",e.article.isNew=!0,e.article.img_url="",e.data.bgImage="",e.data.bg_url="",document.querySelector("#preview").src=""},e.cancelArticle=function(){e.editing=!1},e.updateArticle=function(t){e.editing=!0,e.article.isNew=!1,e.article.title=angular.copy(e.dataList[t].title),e.article.content=angular.copy(e.dataList[t].content),e.article.abstracts=angular.copy(e.dataList[t].abstracts),e.article.id=angular.copy(e.dataList[t].id),e.article.img_url=angular.copy(e.dataList[t].img_url),e.data.bg_url=angular.copy(e.article.img_url),e.data.bgImage=angular.copy(e.article.img_url),e.article.img_url||(document.querySelector("#preview").src="")},e.editArticle=function(){if(""==e.article.title)return r.pop("error","文章管理","标题不能为空！"),!1;if(""==e.article.content)return r.pop("error","文章管理","内容不能为空！"),!1;if(""==e.article.abstracts)return r.pop("error","文章管理","摘要不能为空！"),!1;e.article.isNew?e.uploader.queue.length<=0?e.data.bg_url="":angular.forEach(e.uploader.queue,function(t){e.data.bg_url=t.file.url}):e.uploader.queue.length<=0?e.data.bg_url="":angular.forEach(e.uploader.queue,function(t){e.data.bg_url=t.file.url}),e.submiting=!0,e.submit_html="提交中…";var t=l.editArticle({id:e.article.isNew?"":e.article.id,title:e.article.title,content:e.article.content,abstracts:e.article.abstracts,img_url:e.data.bg_url?e.data.bg_url:e.article.img_url});return t.then(function(t){t&&0==t.code?(r.pop("success","文章管理","保存成功！"),e.article.id="",e.article.title="",e.article.isNew=!1,e.article.content="<h3>请输入内容！</h3>",e.article.abstracts="",e.editing=!1,e.getAllData()):r.pop("error","文章管理",t.message),e.submiting=!1,e.submit_html="提交"},function(){e.submiting=!1,e.submit_html="提交",r.pop("error","文章管理"," 保存文章出错！")})},e.isFirst=function(e){return 1==e},e.isDisable=function(t){return 1==t&&1==e.totalPage?!0:!(t<e.totalPage)},e.getInfoPage=function(t){t<=e.totalPage&&t>0&&(e.page=t,e.getAllData())},e.divpageByPage=function(t){var a=$(t.currentTarget).html(),r=Number(a);angular.isNumber(r)&&r>0&&e.getInfoPage(r)},e.searchData=function(){e.page=1,e.getAllData()},e.dateSelectRange={start:moment(new Date("2016-12-01")).utc().startOf("day"),end:moment().utc().startOf("day")},e.$watch("dateSelectRange",function(t,a){t!=a&&(e.init=!1,e.page=1,e.getAllData())},!0),e.getAllData=function(){e.editing=!1,e.loading=!0;var t=l.getArticlePageData({start:e.dateSelectRange.start.format("YYYY-MM-DD"),end:e.dateSelectRange.end.format("YYYY-MM-DD"),searchkey:e.query,offset:(e.page-1)*e.perPage,num:e.perPage});return t.then(function(t){if(t&&0==t.code)if(0!=t.data.data.length){e.haveData=!0,e.dataList=t.data.data,e.totalPage=Math.ceil(t.data.count/e.perPage);var a=$("#article-page");i.getready(a,e.totalPage,e.page)}else r.pop("error","文章管理","没有数据！"),e.haveData=!1,e.dataList=[];else e.haveData=!1,r.pop("error","文章管理",t.message);e.loading=!1},function(){e.loading=!1,e.haveData=!1,r.pop("error","文章管理","获取文章管理出错！")})},e.$watch("dataList",function(t,a){t!=a&&e.dataList.length>0&&(e.num=0,e.all=0,angular.forEach(e.dataList,function(t,a){t.selected&&e.num++,e.all++}),e.num>0?(e.all_delete_disabled=!1,1==e.num?e.moveable=!0:e.moveable=!1):(e.moveable=!1,e.all_delete_disabled=!0),e.num==e.all?e.selectAll=!0:e.selectAll=!1)},!0),e.$watch("selectAll",function(t,a){t!=a&&e.dataList.length>0&&(t?angular.forEach(e.dataList,function(e,t){e.selected=!0}):(e.count=0,e.all=0,angular.forEach(e.dataList,function(t,a){t.selected&&e.count++,e.all++}),e.count==e.all&&angular.forEach(e.dataList,function(e,t){e.selected=!1})))}),e.submit=!1,e.deleteBatch=function(){if(1==confirm("确定要删除吗?")&&0==e.submit){e.submit=!0,e.idlist=[],angular.forEach(e.dataList,function(t,a){1==t.selected&&e.idlist.push(t.id)}),e.all_delete_disabled=!0;var t=l.deleteArticleBatch({idlist:JSON.stringify(e.idlist)});return t.then(function(t){e.all_delete_disabled=!1,e.all_delete_html="删除",t&&0==t.code?(r.pop("success","文章管理",t.message),e.page=1,e.getAllData()):(e.submit=!1,r.pop("error","文章管理",t.message))},function(){e.submit=!1,e.all_delete_disabled=!1,e.all_delete_html="删除",r.pop("error","文章管理","操作出错！")})}},e.up=function(){if(e.selectSortItem="",e.selectSortIndex="",angular.forEach(e.dataList,function(t,a){t.selected&&(e.selectSortItem=angular.copy(t),e.selectSortIndex=angular.copy(a))}),""!=e.selectSortItem&&""!==e.selectSortIndex)if(e.offset=(e.page-1)*e.perPage+e.selectSortIndex-1,e.offset<0)r.pop("error","文章管理","没有上一条了");else{var t="up";e.changeSortEachother(e.selectSortItem.id,e.selectSortItem.sort_id,e.offset,t)}else r.pop("error","文章管理","操作出错！")},e.down=function(){if(e.selectSortItem="",e.selectSortIndex="",angular.forEach(e.dataList,function(t,a){t.selected&&(e.selectSortItem=angular.copy(t),e.selectSortIndex=angular.copy(a))}),""!=e.selectSortItem&&""!==e.selectSortIndex){var t="down";e.offset=(e.page-1)*e.perPage+e.selectSortIndex+1,e.changeSortEachother(e.selectSortItem.id,e.selectSortItem.sort_id,e.offset,t)}else r.pop("error","文章管理","操作出错！")},e.top=function(){e.selectSortItem="",angular.forEach(e.dataList,function(t,a){t.selected&&(e.selectSortItem=angular.copy(t))});var t=l.changeArticleSortTop({id:e.selectSortItem.id});return t.then(function(t){t&&0==t.code?(e.page=1,e.getAllData()):r.pop("error","文章管理",t.message)},function(){r.pop("error","文章管理","操作出错！")})},e.changeSortEachother=function(t,a,i,n){var o=l.changeSortArticle({id:t,sort_id:a,offset:i,type:n});return o.then(function(t){t&&0==t.code?e.getAllData():r.pop("error","文章管理",t.message)},function(){r.pop("error","文章管理","操作出错！")})};var o=e.uploader=new n({url:"/backend/upload_soft.php"});o.filters.push({name:"customFilter",fn:function(e,t){return this.queue.length<10}}),o.onAfterAddingFile=function(t){angular.forEach(e.uploader.queue,function(t){var a=t.file.name;return-1===a.indexOf(".jpg")&&-1===a.indexOf(".jpeg")&&-1===a.indexOf(".png")&&-1===a.indexOf(".gif")?(r.pop("error","封面设置","上传文件扩展名必须为：.jpg .png .jpeg .gif"),e.uploader.queue.pop(),!1):void(e.uploader.queue.length>1&&e.uploader.queue.splice(0,1))})},o.onCompleteItem=function(t,a,l,i){0==a.code?($(".bootstrap-filestyle").children("input").val(""),t.file.url="/backend/uploads/"+a.file,t.file.save_file_name=a.file,e.editArticle()):r.pop("error","封面设置",a.answer)},angular.element(document.querySelector("#fileInput")).on("change",function(t){var a=t.currentTarget.files[0],r=new FileReader;r.onload=function(t){e.$apply(function(e){e.data.bgImage=t.target.result})},r.readAsDataURL(a)}),e.submitArticle=function(){e.uploader.queue.length<=0&&!e.article.isNew?e.editArticle():e.uploader.queue.length>=1?o.uploadAll():e.editArticle()}}]);
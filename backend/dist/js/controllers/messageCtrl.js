angular.module("app").controller("MessageCtrl",["$scope","CommonFunction","DataLoad","toaster","divpage","$modal","$stateParams",function(a,e,t,l,i,n,d){a.haveData=!0,a.loading=!0,a.query="",a.page=1,a.totalPage=1,a.perPage=10,a.dataList=[],a.init=!0,a.selectAll=!1,a.all_delete_disabled=!0,a.all_delete_html="删除",a.submit=!1,a.init_loading=!0,a.radioModel=99,angular.isUndefined(d.userid)?a.userid="empty":a.userid=d.userid,a.$watch("radioModel",function(e,t){e!=t&&(a.init_loading||(a.page=1,a.getAllData()))}),a.dateSelectSingle={start:moment(new Date).utc().startOf("day"),end:""},a.$watch("dateSelectSingle.start",function(e,t){e!=t&&(a.init=!1,a.page=1,a.getAllData())},!0),a.$watch("status",function(e,t){e!=t&&(a.page=1,a.getAllData())}),a.getAllData=function(){a.loading=!0;var e=t.getMessagePageData({searchkey:a.query,status:a.radioModel,time:a.init?"":a.dateSelectSingle.end.format("YYYY-MM-DD"),offset:(a.page-1)*a.perPage,num:a.perPage,userid:a.userid});return e.then(function(e){if(e&&0==e.code)if(0!=e.data.data.length){a.haveData=!0,a.dataList=e.data.data,a.totalPage=Math.ceil(e.data.count/a.perPage);var t=$("#divpage-page");i.getready(t,a.totalPage,a.page)}else a.dataList=[],l.pop("success","短信记录","没有数据！"),a.haveData=!1;else a.dataList=[],a.haveData=!1,l.pop("error","短信记录",e.message);a.loading=!1,a.init_loading=!1},function(){a.dataList=[],a.haveData=!1,a.loading=!1,a.init_loading=!1,l.pop("error","短信记录","获取数据出错！")})},a.getAllData(),a.isFirst=function(a){return 1==a},a.isDisable=function(e){return 1==e&&1==a.totalPage?!0:!(e<a.totalPage)},a.getInfoPage=function(e){e<=a.totalPage&&e>0&&(a.page=e,a.getAllData())},a.divpageByPage=function(e){var t=$(e.currentTarget).html(),l=Number(t);angular.isNumber(l)&&l>0&&a.getInfoPage(l)},a.searchData=function(){a.page=1,a.getAllData()},a.$watch("dataList",function(e,t){e!=t&&a.dataList.length>0&&(a.num=0,a.all=0,angular.forEach(a.dataList,function(e,t){e.selected&&a.num++,a.all++}),a.num>0?a.all_delete_disabled=!1:a.all_delete_disabled=!0,a.num==a.all?a.selectAll=!0:a.selectAll=!1)},!0),a.$watch("selectAll",function(e,t){e!=t&&a.dataList.length>0&&(e?angular.forEach(a.dataList,function(a,e){a.selected=!0}):(a.count=0,a.all=0,angular.forEach(a.dataList,function(e,t){e.selected&&a.count++,a.all++}),a.count==a.all&&angular.forEach(a.dataList,function(a,e){a.selected=!1})))}),a.deleteBatch=function(){if(1==confirm("确定要删除吗?")&&0==a.submit){a.submit=!0,a.idlist=[],angular.forEach(a.dataList,function(e,t){1==e.selected&&a.idlist.push(e.id)});var e=t.deleteMessageBatch({idlist:JSON.stringify(a.idlist)});return e.then(function(e){a.all_disagree_disabled=!1,a.all_delete_html="删除",e&&0==e.code?(l.pop("success","短信记录",e.message),location.reload()):(a.submit=!1,l.pop("error","短信记录",e.message))},function(){a.submit=!1,a.all_disagree_disabled=!1,a.all_delete_html="删除",l.pop("error","短信记录","操作出错！")})}}}]);
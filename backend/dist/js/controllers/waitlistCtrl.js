angular.module("app").controller("WaitlistCtrl",["$scope","CommonFunction","DataLoad","toaster","divpage","$modal","$stateParams",function(t,a,e,l,i,n,o){t.haveData=!0,t.loading=!0,t.query="",t.page=1,t.totalPage=1,t.perPage=10,t.dataList=[],t.init=!0,t.selectAll=!1,t.all_delete_disabled=!0,t.all_delete_html="删除",t.submit=!1,t.init_loading=!0,t.radioModel=99,t.shoot_point=0,t.future_point=0,angular.isUndefined(o.userid)?t.userid="empty":t.userid=o.userid,t.$watch("radioModel",function(a,e){a!=e&&(t.init_loading||(t.page=1,t.getAllData()))}),t.dateSelectSingle={start:moment(new Date).utc().startOf("day"),end:""},t.$watch("dateSelectSingle.start",function(a,e){a!=e&&(t.init=!1,t.page=1,t.getAllData())},!0),t.monthAgo=function(){var t=new Date,a=t.getTime()-2592e6,e=new Date;e.setTime(a);var l=moment(e).utc().startOf("day").format("YYYY-MM-DD");return l},t.dateSelectRange={start:moment(t.monthAgo()).utc().startOf("day"),end:moment().utc().startOf("day")},t.$watch("dateSelectRange",function(a,e){a!=e&&(t.init=!1,t.page=1,t.getAllData())},!0),t.$watch("status",function(a,e){a!=e&&(t.page=1,t.getAllData())}),t.getAllData=function(){t.loading=!0;var a=e.getWaitPageData({searchkey:t.query,status:t.radioModel,start:t.dateSelectRange.start.format("YYYY-MM-DD"),end:t.dateSelectRange.end.format("YYYY-MM-DD"),offset:(t.page-1)*t.perPage,num:t.perPage,userid:t.userid});return a.then(function(a){if(a&&0==a.code)if(t.shoot_point=a.data.shoot_point,t.future_point=a.data.future_point,0!=a.data.data.length){t.haveData=!0,t.dataList=a.data.data,t.totalPage=Math.ceil(a.data.count/t.perPage);var e=$("#divpage-page");i.getready(e,t.totalPage,t.page),angular.forEach(t.dataList,function(t,a){t.clear_html="结算",t.clear_disabled=!1})}else t.dataList=[],l.pop("success","待用积分","没有数据！"),t.haveData=!1;else t.shoot_point=0,t.future_point=0,t.dataList=[],t.haveData=!1,l.pop("error","待用积分",a.message);t.loading=!1,t.init_loading=!1},function(){t.shoot_point=0,t.future_point=0,t.dataList=[],t.haveData=!1,t.loading=!1,t.init_loading=!1,l.pop("error","待用积分","获取数据出错！")})},t.getAllData(),t.isFirst=function(t){return 1==t},t.isDisable=function(a){return 1==a&&1==t.totalPage?!0:!(a<t.totalPage)},t.getInfoPage=function(a){a<=t.totalPage&&a>0&&(t.page=a,t.getAllData())},t.divpageByPage=function(a){var e=$(a.currentTarget).html(),l=Number(e);angular.isNumber(l)&&l>0&&t.getInfoPage(l)},t.searchData=function(){t.page=1,t.getAllData()},t.$watch("dataList",function(a,e){a!=e&&t.dataList.length>0&&(t.num=0,t.all=0,angular.forEach(t.dataList,function(a,e){a.selected&&t.num++,t.all++}),t.num>0?t.all_delete_disabled=!1:t.all_delete_disabled=!0,t.num==t.all?t.selectAll=!0:t.selectAll=!1)},!0),t.$watch("selectAll",function(a,e){a!=e&&t.dataList.length>0&&(a?angular.forEach(t.dataList,function(t,a){t.selected=!0}):(t.count=0,t.all=0,angular.forEach(t.dataList,function(a,e){a.selected&&t.count++,t.all++}),t.count==t.all&&angular.forEach(t.dataList,function(t,a){t.selected=!1})))}),t.deleteBatch=function(){if(1==confirm("确定要删除吗?")&&0==t.submit){t.submit=!0,t.idlist=[],angular.forEach(t.dataList,function(a,e){1==a.selected&&t.idlist.push(a.id)});var a=e.deleteWaitBatch({idlist:JSON.stringify(t.idlist)});return a.then(function(a){t.all_disagree_disabled=!1,t.all_delete_html="删除",a&&0==a.code?(l.pop("success","待用积分",a.message),location.reload()):(t.submit=!1,l.pop("error","待用积分",a.message))},function(){t.submit=!1,t.all_disagree_disabled=!1,t.all_delete_html="删除",l.pop("error","待用积分","操作出错！")})}},t.todo=function(a){if(1==confirm("确定要结算吗?")&&0==t.submit){t.submit=!0,a.clear_html="提交中…",a.clear_disabled=!0;var i=e.clearWaitPoint({id:a.id});return i.then(function(e){e&&0==e.code?(l.pop("success","待用积分",e.message),t.getAllData()):(t.submit=!1,l.pop("error","待用积分",e.message)),a.clear_html="结算",a.clear_disabled=!1},function(){t.submit=!1,a.clear_html="结算",a.clear_disabled=!1,l.pop("error","待用积分","操作出错！")})}}}]);